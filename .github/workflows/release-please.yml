on:
    push:
        branches:
            - main

permissions:
    contents: write
    pull-requests: write
    id-token: write
    issues: write

name: release-please

jobs:
    ci:
        uses: ./.github/workflows/ci.yml
        secrets: inherit

    release-please:
        permissions:
            contents: write
            pull-requests: write
            issues: write
        runs-on: ubuntu-latest
        needs: ci
        outputs:
            releases_created: ${{ steps.release.outputs.releases_created }}
            es-ds-styles--version: ${{ steps.release.outputs.es-ds-styles--version }}
            es-ds-styles--release_created: ${{ steps.release.outputs.es-ds-styles--release_created }}
            es-ds-components--version: ${{ steps.release.outputs.es-ds-components--version }}
            es-ds-components--release_created: ${{ steps.release.outputs.es-ds-components--release_created }}
            es-ds-docs--version: ${{ steps.release.outputs.es-ds-docs--version }}
            es-ds-docs--release_created: ${{ steps.release.outputs.es-ds-docs--release_created }}
        steps:
            - uses: googleapis/release-please-action@v4
              id: 'release'

    release-es-ds-styles:
        permissions:
            contents: read
        runs-on: ubuntu-latest
        needs: release-please
        if: needs.release-please.outputs.es-ds-styles--release_created
        steps:
            - name: Check out repository code
              uses: actions/checkout@v4

            - name: Get nodenv version 🔌
              id: nodenv
              shell: bash
              run: echo "node-version=$(cat .node-version)" >> $GITHUB_OUTPUT

            - name: Set up Node@${{ steps.nodenv.outputs.node-version }} 🏗
              uses: actions/setup-node@v4
              with:
                  node-version: '${{ steps.nodenv.outputs.node-version }}'
                  registry-url: 'https://registry.npmjs.org'
                  cache: npm
                  cache-dependency-path: '**/package-lock.json'

            - name: Install dependencies
              working-directory: es-ds-styles
              run: npm install

            - name: Publish Packages
              working-directory: es-ds-styles
              id: publish-packages
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_PUBLISH_TOKEN }}
              run: |
                  npm run build
                  npm publish

    release-es-ds-components:
        permissions:
            contents: write
        runs-on: ubuntu-latest
        needs:
            - release-please
            - release-es-ds-styles
        if: always() && !cancelled() && !failure() && needs.release-please.outputs.es-ds-components--release_created
        steps:
            # Uses an app with elevated permissions to bypass required checks when pushing to main
            - uses: actions/create-github-app-token@v2
              id: app-token
              with:
                app-id: ${{ vars.VERSION_BUMPER_APPID }}
                private-key: ${{ secrets.VERSION_BUMPER_SECRET }}

            - name: Check out repository code
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.head_ref }}
                  fetch-depth: 0
                  token: ${{ steps.app-token.outputs.token }}

            - name: Get nodenv version 🔌
              id: nodenv
              shell: bash
              run: echo "node-version=$(cat .node-version)" >> $GITHUB_OUTPUT

            - name: Set up Node@${{ steps.nodenv.outputs.node-version }} 🏗
              uses: actions/setup-node@v4
              with:
                  node-version: '${{ steps.nodenv.outputs.node-version }}'
                  registry-url: 'https://registry.npmjs.org'
                  cache: npm
                  cache-dependency-path: '**/package-lock.json'

              # release-please increments the version in some places but not everywhere due to inherent limitations.
              # Obtaining the new version number is needed to explicitly install it.
            - id: set_es_ds_styles_version
              name: Get es-ds-styles version
              working-directory: es-ds-components
              run: echo "version_string=$(cat package.json | jq -r '.["dependencies"].["@energysage/es-ds-styles"]')" >> $GITHUB_OUTPUT

            - name: Install dependencies
              working-directory: es-ds-components
              run: npm install @energysage/es-ds-styles@${{ steps.set_es_ds_styles_version.outputs.version_string }}

            - name: Commit package-lock.json changes
              uses: stefanzweifel/git-auto-commit-action@v6
              with:
                  commit_message: "chore: update es-ds-components package-lock.json"

            - name: Publish Packages
              working-directory: es-ds-components
              id: publish-packages
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_PUBLISH_TOKEN }}
              run: |
                  npm publish

    release-es-ds-docs:
        permissions:
            contents: write
        runs-on: ubuntu-latest
        needs:
            - release-please
            - release-es-ds-styles
            - release-es-ds-components
        if: always() && !cancelled() && !failure() && needs.release-please.outputs.es-ds-docs--release_created
        steps:
            # Uses an app with elevated permissions to bypass required checks when pushing to main
            - uses: actions/create-github-app-token@v2
              id: app-token
              with:
                app-id: ${{ vars.VERSION_BUMPER_APPID }}
                private-key: ${{ secrets.VERSION_BUMPER_SECRET }}

            - name: Check out repository code
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.head_ref }}
                  fetch-depth: 0
                  token: ${{ steps.app-token.outputs.token }}

            - name: Get nodenv version 🔌
              id: nodenv
              shell: bash
              run: echo "node-version=$(cat .node-version)" >> $GITHUB_OUTPUT

            - name: Set up Node@${{ steps.nodenv.outputs.node-version }} 🏗
              uses: actions/setup-node@v4
              with:
                  node-version: '${{ steps.nodenv.outputs.node-version }}'
                  registry-url: 'https://registry.npmjs.org'
                  cache: npm
                  cache-dependency-path: '**/package-lock.json'

            # release-please increments the version in some places but not everywhere due to inherent limitations.
            # Obtaining the new version number is needed to explicitly install it.
            - id: set_es_ds_styles_version
              name: Get es-ds-styles version
              working-directory: es-ds-docs
              run: echo "version_string=$(cat package.json | jq -r '.["dependencies"].["@energysage/es-ds-styles"]')" >> $GITHUB_OUTPUT

            - id: set_es_ds_components_version
              name: Get es-ds-components version
              working-directory: es-ds-docs
              run: echo "version_string=$(cat package.json | jq -r '.["dependencies"].["@energysage/es-ds-components"]')" >> $GITHUB_OUTPUT

            - name: Install dependencies
              working-directory: es-ds-docs
              run: npm install @energysage/es-ds-styles@${{ steps.set_es_ds_styles_version.outputs.version_string }} @energysage/es-ds-components@${{ steps.set_es_ds_components_version.outputs.version_string }}

            - name: Commit package-lock.json changes
              uses: stefanzweifel/git-auto-commit-action@v6
              with:
                  commit_message: "chore: update es-ds-docs package-lock.json"

    deploy:
        uses: ./.github/workflows/deploy.yml
        needs:
            - release-please
            - release-es-ds-styles
            - release-es-ds-components
            - release-es-ds-docs
        if: always() && !cancelled() && !failure() && (needs.release-please.outputs.es-ds-styles--release_created || needs.release-please.outputs.es-ds-components--release_created || needs.release-please.outputs.es-ds-docs--release_created)
        secrets: inherit
        with:
            environment: int
            trigger: automated release
